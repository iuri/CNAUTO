ad_library {
    CN Auto Resources API
}


namespace eval cn_resources {}
namespace eval cn_resources::cn_vehicle {}


ad_proc -public cn_vehicle::new { 
    {-chassis}
    {-model}
    {-year_of_model ""}
    {-year_of_fabrication ""}
    {-engine ""}
    {-color ""}
    {-arrival_date ""}
    {-billing_date ""}
    {-purchase_date ""}
    {-duration ""}
    {-distributor_code ""}
    {-person_id ""}
    {-notes ""}
    {-creation_ip ""}
    {-creation_user ""}
    {-context_id ""}
} {
    Add a new vehicle 
} {
     
    if {$creation_ip == ""} {
	set creation_ip [ad_conn peeraddr]
    }
    
    if {$creation_user == ""} {
	set creation_user [ad_conn user_id]
    }
     
    if {$context_id == ""} {
	set context_id [ad_conn package_id]
    }


   #set vehicle_id [db_nextval acs_object_id_seq]
	
    set vehicle_id [db_exec_plsql insert_vehicle {
	SELECT cn_vehicle__new (
				null,
				:chassis,
				:engine,
				:model,
				:year_of_model,
				:year_of_fabrication,
				:color,
				:purchase_date,
				:arrival_date,	
				:billing_date,
				:duration,
				:distributor_code,
				:person_id,
				:notes,
				:creation_ip,
				:creation_user,
				:context_id
				)
    }]
    
    return $vehicle_id
}



ad_proc -public cn_resources::get_city_code {
    {-city $city}
} {
    Returns city's code
} {

    
    set city [cn_core::util::treat_string -str $str]

    # WHERE name like [lindex city 0]
    db_foreach {
	SELECT ibge_code, name FROM br_ibge_municipality ORDER BY municipality
    } {
	ns_log Notice "$element"
    }
    return $city_code
}


namespace eval cn_resources::persons {}

ad_proc -public  cn_resources::persons::import_csv_file {
    {-input_file}
} {

    Imports CSV files to add assurance requires
} {

    ns_log Notice "Running ad_proc cn_assurance::import_csv_file"

    set input_file [open "${input_file}" r]
    set lines [split [read $input_file] \n]
    close $input_file

    
    foreach line $lines {
	set line [split $line {;}] 
	ns_log Notice "LINE $line"
	
	# 0 CIDADE
	# 1 ESTADO
	# 2 NOME FANTASIA
	# 3 RAZÃO SOCIAL
	# 4 CNPJ
	# 5 CODIGO
	# 6 TIPO
	# 7 CONTATO
	# 8 TELEFONE
	# 9 ENDEREÇO
	# 10 CEP
	# 11 E-mail Titular

	set city [lindex $line 0]
	set city_code [cn_resources::get_city_code -city $city]
	
	set state [lindex $line 1]
	#set state_code [cn_resources::get_state_code -state $state]

	set corporate_name [lindex $line 2] 
	set legal_name [lindex $line 3]
	set cpf_cnpj [lindex $line 4]
	set code [lindex $line 5]
	set type [lindex $line 6]

	set first_names [lindex $line 8]
	set last_name $last_name \
	set email $email \
	    -type $type \
	    -phone $phone \
	    -postal_address $postal_address2 \
	    -postal_address2 $postal_address2 \
	    -postal_code $postal_code \
	    -city_code $city_code \
	    -country_code $country_code \
	

	cn_resources::person::new \
	    -cpf_cnpj $cpf_cnpj \
	    -legal_name $legal_name \
	    -corporate_name $corporate_name \
	    -code $code \
	    -first_names $first_names \
	    -last_name $last_name \
	    -email $email \
	    -type $type \
	    -phone $phone \
	    -postal_address $postal_address2 \
	    -postal_address2 $postal_address2 \
	    -postal_code $postal_code \
	    -state_code $state \
	    -city_code $city_code \
	    -country_code $country_code \
	    -creation_ip [ad_conn peeraddr] \
	    -creation_user [ad_conn user_id] \
	    -context_id [ad_conn package_id]    
	
	
	
    }
    
    return
}

namespace eval cn_resources::person {}

ad_proc -public cn_resources::person::new {
    {-cpf_cnpj}
    {-legal_name ""}
    {-corporate_name ""}
    {-code ""}
    {-type ""}
    {-first_names ""}
    {-last_name ""}
    {-email ""}
    {-phone ""}
    {-postal_address ""}
    {-postal_address2 ""}
    {-postal_code ""}
    {-state_code ""}
    {-city_code ""}
    {-country_code "BR"}
    {-creation_ip ""}
    {-creation_user ""}
    {-context_id ""}    
} {
    Add a new person

    @author Iuri Sampaio (iuri.sampaio@iurix.com)
    @creation-date 2011-12-12

} {

    if {$creation_ip == ""} {
	set creation_ip [ad_conn peeraddr]
    }
    
    if {$creation_user == ""} {
	set creation_user [ad_conn user_id]
    }
    
    if {$context_id == ""} {
	set context_id [ad_conn package_id]
    }



    ns_log Notice "
	-cpf_cnpj $cpf_cnpj \n
        -legal_name $legal_name \n
        -corporate_name $corporate_name \n
        -code $code \n
	-first_names $first_names \n
	-last_name $last_name \n
	-email $email \n
	-type $type \n
	-phone $phone \n
	-postal_address $postal_address2 \n
	-postal_address2 $postal_address2 \n
	-postal_code $postal_code \n
	-state_code $state_code \n
	-city_code $city_code \n
	-country_code $country_code \n
	-creation_ip $creation_ip \n
	-creation_user $creation_user \n 
	-context_id $context_id    
    "

    
    
    set person_id [db_exec_plsql insert_person {
	SELECT cn_person__new (
			       :cpf_cnpj,
			       :legal_name,
			       :corporate_name,
			       :code,
			       :type,
			       :contact_id -- user_id
			       :email,
			       :phone,
			       :postal_address,
			       :postal_address2,
			       :postal_code,
			       :state_code,
			       :city_code,
			       :country_code,
			       :creation_ip,
			       :creation_user,
			       :context_id
			       );
    }]
    
    return $person_id
    
}

